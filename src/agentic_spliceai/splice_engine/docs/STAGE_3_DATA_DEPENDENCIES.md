# Stage 3: Data Dependencies Analysis

**Purpose**: Map all data files required by the Meta-SpliceAI base layer workflow  
**Date**: December 10, 2025

---

## Overview

The Meta-SpliceAI base layer is **model-agnostic** - it supports any base model that produces per-nucleotide splice site scores (donor, acceptor, neither). Currently supported models:

| Base Model | Genome Build | Annotation Source | Training Data |
|------------|--------------|-------------------|---------------|
| **SpliceAI** | GRCh37 (hg19) | Ensembl (GENCODE V24lift37) | Ensembl release 87 |
| **OpenSpliceAI** | GRCh38.p14 | MANE v1.3 RefSeq | MANE Select transcripts |

**Critical**: Each base model requires data files matching its training specifications. Using mismatched data causes significant performance degradation (up to 44% drop in PR-AUC).

The base layer workflow requires several categories of data files:

1. **INPUT files** - External resources that must be provided (model-specific)
2. **DERIVED files** - Generated by the workflow from input files
3. **OUTPUT files** - Final results produced by the workflow

---

## Complete Data File Reference

### Category 1: INPUT Files (Must Be Provided)

#### Model-Specific Input Requirements

| Data Type | SpliceAI (GRCh37) | OpenSpliceAI (GRCh38) |
|-----------|-------------------|----------------------|
| **Reference Genome** | `Homo_sapiens.GRCh37.dna.primary_assembly.fa` | `GCF_000001405.40_GRCh38.p14_genomic.fna` |
| **Gene Annotations** | `Homo_sapiens.GRCh37.87.gtf` (Ensembl GTF) | `MANE.GRCh38.v1.3.refseq_genomic.gff` (MANE GFF3) |
| **Model Weights** | `spliceai1-5.h5` (Keras HDF5) | `openspliceai1-5.pt` (PyTorch) |
| **Data Directory** | `data/ensembl/GRCh37/` | `data/mane/GRCh38/` |

#### Generic Input File Specifications

| Data Type | File Format | Purpose | Source |
|-----------|-------------|---------|--------|
| **Reference Genome** | FASTA (.fa, .fna) | Nucleotide sequences for all chromosomes | Ensembl/NCBI RefSeq |
| **Gene Annotations** | GTF or GFF3 | Gene, transcript, exon coordinates | Ensembl/GENCODE/MANE |
| **Base Model Weights** | HDF5 (.h5) or PyTorch (.pt) | Pre-trained neural network weights | Model-specific package |

#### Reference Genome Details

```
File: GRCh38.primary_assembly.genome.fa
Size: ~3.1 GB (uncompressed)
Format: Multi-FASTA with chromosome sequences
Source: ftp://ftp.ensembl.org/pub/release-112/fasta/homo_sapiens/dna/

Content:
>1 dna:chromosome chromosome:GRCh38:1:1:248956422:1 REF
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNN...
>2 dna:chromosome chromosome:GRCh38:2:1:242193529:1 REF
NNNNNNNNNNNNNNNNNNNNNNNNNNNNNN...
...
```

#### Gene Annotations Details

```
File: Homo_sapiens.GRCh38.112.gtf
Size: ~1.5 GB (uncompressed)
Format: GTF (Gene Transfer Format)
Source: ftp://ftp.ensembl.org/pub/release-112/gtf/homo_sapiens/

Content (tab-separated):
1  ensembl  gene        11869  14409  .  +  .  gene_id "ENSG00000223972"; ...
1  ensembl  transcript  11869  14409  .  +  .  gene_id "ENSG00000223972"; transcript_id "ENST00000456328"; ...
1  ensembl  exon        11869  12227  .  +  .  gene_id "ENSG00000223972"; transcript_id "ENST00000456328"; exon_number "1"; ...
```

#### SpliceAI Model Details

```
Files: spliceai1.h5, spliceai2.h5, spliceai3.h5, spliceai4.h5, spliceai5.h5
Size: ~50 MB each (~250 MB total)
Format: Keras HDF5 model format
Source: Installed with `pip install spliceai`
Location: site-packages/spliceai/models/

Loading:
from pkg_resources import resource_filename
from keras.models import load_model

paths = ('models/spliceai{}.h5'.format(x) for x in range(1, 6))
models = [load_model(resource_filename('spliceai', x)) for x in paths]
```

---

### Category 2: DERIVED Files (Generated from Inputs)

| Data Type | File Format | Example Filename | Purpose | Generated By |
|-----------|-------------|------------------|---------|--------------|
| **Annotations DB** | SQLite (.db) | `annotations.db` | Indexed transcript metadata | `prepare_gene_annotations()` |
| **Transcript Annotations** | TSV | `annotations_all_transcripts.tsv` | Flat file of all transcripts | `prepare_gene_annotations()` |
| **Splice Sites** | TSV | `splice_sites_enhanced.tsv` | Known donor/acceptor positions | `prepare_splice_site_annotations()` |
| **Gene Sequences** | Parquet | `gene_sequences_chr1.parquet` | Per-chromosome gene sequences | `prepare_genomic_sequences()` |
| **Overlapping Genes** | TSV | `overlapping_gene_counts.tsv` | Genes with overlapping regions | `handle_overlapping_genes()` |
| **Gene Features** | TSV | `gene_features.tsv` | Gene metadata (biotype, length) | `GenomicDataDeriver` |

#### Annotations Database Details

```
File: annotations.db
Size: ~200-500 MB
Format: SQLite database
Location: {local_dir}/annotations.db

Tables:
- transcripts: transcript_id, gene_id, chrom, start, end, strand
- exons: exon_id, transcript_id, start, end, exon_number
- features: feature_id, transcript_id, feature_type, start, end

Generated by:
from meta_spliceai.splice_engine.extract_genomic_features import extract_annotations
extract_annotations(gtf_file, db_file='annotations.db', output_file='annotations_all_transcripts.tsv')
```

#### Transcript Annotations Details

```
File: annotations_all_transcripts.tsv
Size: ~100-300 MB
Format: Tab-separated values
Location: {local_dir}/annotations_all_transcripts.tsv

Columns:
chrom          str      Chromosome (1-22, X, Y, MT)
start          int      Feature start position (1-based)
end            int      Feature end position (1-based)
strand         str      Strand ('+' or '-')
feature        str      Feature type (exon, CDS, UTR, etc.)
gene_id        str      Ensembl gene ID (ENSG...)
transcript_id  str      Ensembl transcript ID (ENST...)
```

#### Splice Sites Details

```
File: splice_sites_enhanced.tsv
Size: ~50-100 MB
Format: Tab-separated values
Location: {local_dir}/splice_sites_enhanced.tsv

Columns:
chrom          str      Chromosome
position       int      Splice site genomic position
strand         str      Strand ('+' or '-')
splice_type    str      'donor' or 'acceptor'
gene_id        str      Gene identifier
transcript_id  str      Transcript identifier
consensus      str      Dinucleotide consensus (GT/AG)

Row count: ~500,000 splice sites (human genome)
```

#### Gene Sequences Details

```
Files: gene_sequences_chr{1-22,X,Y}.parquet
Size: ~100-500 MB per chromosome
Format: Apache Parquet (columnar)
Location: {local_dir}/gene_sequences_chr{N}.parquet

Columns:
gene_id        str      Ensembl gene ID
gene_name      str      Gene symbol (e.g., BRCA1)
chrom          str      Chromosome
start          int      Gene start position
end            int      Gene end position
strand         str      Strand
sequence       str      Full nucleotide sequence

Why Parquet?
- Columnar format enables efficient filtering
- Compression reduces disk usage by ~70%
- Supports lazy loading via Polars LazyFrame
```

#### Overlapping Genes Details

```
File: overlapping_gene_counts.tsv
Size: ~5-10 MB
Format: Tab-separated values
Location: {local_dir}/overlapping_gene_counts.tsv

Columns:
gene_id              str      Gene identifier
chrom                str      Chromosome
strand               str      Strand
start                int      Gene start position
end                  int      Gene end position
overlapping_count    int      Number of overlapping genes
overlapping_gene_ids str      Comma-separated overlapping gene IDs

Purpose: Identify ambiguous splice sites shared by multiple genes
```

#### Gene Features Details

```
File: gene_features.tsv
Size: ~5-10 MB
Format: Tab-separated values
Location: {local_dir}/gene_features.tsv

Columns:
gene_id        str      Ensembl gene ID
gene_name      str      Gene symbol
gene_type      str      Biotype (protein_coding, lncRNA, etc.)
chrom          str      Chromosome
start          int      Gene start
end            int      Gene end
strand         str      Strand
gene_length    int      Gene length in bp
exon_count     int      Number of exons
transcript_count int    Number of transcripts

Purpose: Enable biotype-specific analysis and sampling
```

---

### Category 3: OUTPUT Files (Workflow Results)

| Data Type | File Format | Example Filename | Purpose | Generated By |
|-----------|-------------|------------------|---------|--------------|
| **Splice Positions** | TSV | `splice_positions_enhanced_*.tsv` | Position-level features (~58 cols) | `enhanced_process_predictions_with_all_scores()` |
| **Error Analysis** | TSV | `error_analysis_*.tsv` | Per-gene error metrics | `enhanced_process_predictions_with_all_scores()` |
| **Analysis Sequences** | TSV | `analysis_sequences_*.tsv` | Nucleotide context around splice sites | `extract_analysis_sequences()` |
| **Nucleotide Scores** | TSV | `nucleotide_scores_*.tsv` | Per-nucleotide probabilities (optional) | Main workflow (if enabled) |

#### Splice Positions Details

```
Files: 
- Per-chunk: splice_positions_enhanced_{chr}_chunk_{start}_{end}.tsv
- Aggregated: splice_positions_enhanced_aggregated.tsv

Size: ~500 MB - 2 GB (aggregated)
Format: Tab-separated values
Location: {eval_dir}/meta_models/

Key Columns (~58 total):
# Identifiers
gene_id, gene_name, chrom, position, strand, splice_type

# Raw SpliceAI scores
donor_score, acceptor_score, neither_score

# Context scores (±2 positions)
context_donor_minus2, context_donor_minus1, context_donor_plus1, context_donor_plus2
context_acceptor_minus2, context_acceptor_minus1, context_acceptor_plus1, context_acceptor_plus2

# Derived features
donor_acceptor_ratio, donor_neither_ratio, acceptor_neither_ratio
log_odds_donor, log_odds_acceptor
entropy, max_score, score_margin
donor_surge, acceptor_surge, peak_sharpness
... (see BASE_LAYER_FEATURE_SET.md for complete list)

# Labels
label (0=TN, 1=TP for splice sites)
```

#### Error Analysis Details

```
Files:
- Per-chunk: error_analysis_{chr}_chunk_{start}_{end}.tsv
- Aggregated: error_analysis_aggregated.tsv

Size: ~10-50 MB (aggregated)
Format: Tab-separated values
Location: {eval_dir}/meta_models/

Columns:
gene_id           str      Gene identifier
gene_name         str      Gene symbol
chrom             str      Chromosome
n_true_positives  int      Correctly predicted splice sites
n_false_positives int      Incorrectly predicted splice sites
n_false_negatives int      Missed splice sites
n_true_negatives  int      Correctly rejected non-splice sites
precision         float    TP / (TP + FP)
recall            float    TP / (TP + FN)
f1_score          float    Harmonic mean of precision and recall
```

#### Analysis Sequences Details

```
Files:
- Per-chunk: analysis_sequences_{chr}_chunk_{start}_{end}.tsv
- Aggregated: analysis_sequences_aggregated.tsv

Size: ~1-5 GB (aggregated)
Format: Tab-separated values
Location: {eval_dir}/meta_models/

Columns:
gene_id        str      Gene identifier
gene_name      str      Gene symbol
chrom          str      Chromosome
position       int      Splice site position
strand         str      Strand
splice_type    str      'donor' or 'acceptor'
sequence       str      Nucleotide sequence (±250bp window)
label          int      Ground truth label
position_id    str      Unique position identifier

Purpose: Sequence context for downstream analysis (motif discovery, etc.)
```

---

## Directory Structure

### Multi-Model Directory Layout

The directory structure enforces correct data-model pairing through physical separation:

```text
data/
├── ensembl/GRCh37/                   # SpliceAI data (GRCh37)
│   ├── Homo_sapiens.GRCh37.87.gtf   # INPUT: Ensembl GTF
│   ├── Homo_sapiens.GRCh37.dna.primary_assembly.fa  # INPUT: Reference
│   ├── annotations.db               # DERIVED
│   ├── splice_sites_enhanced.tsv    # DERIVED
│   ├── gene_features.tsv            # DERIVED
│   ├── gene_sequences_chr*.parquet  # DERIVED
│   └── spliceai_eval/               # OUTPUT
│       └── meta_models/
│           └── ...
│
├── mane/GRCh38/                      # OpenSpliceAI data (GRCh38)
│   ├── MANE.GRCh38.v1.3.refseq_genomic.gff  # INPUT: MANE GFF3
│   ├── GCF_000001405.40_GRCh38.p14_genomic.fna  # INPUT: RefSeq FASTA
│   ├── annotations.db               # DERIVED
│   ├── splice_sites_enhanced.tsv    # DERIVED
│   ├── gene_features.tsv            # DERIVED
│   ├── gene_sequences_chr*.parquet  # DERIVED
│   └── openspliceai_eval/           # OUTPUT
│       └── meta_models/
│           └── ...
│
└── models/                           # Model weights
    ├── spliceai/                     # SpliceAI (Keras)
    │   ├── spliceai1.h5
    │   └── ... (5 models)
    └── openspliceai/                 # OpenSpliceAI (PyTorch)
        ├── openspliceai1.pt
        └── ... (5 models)
```

**Key Design Principle**: `data/<annotation_source>/<build>/` structure prevents accidental mixing of incompatible data.

---

## Data Flow Diagram

### Model-Agnostic Data Flow

The following diagram shows the complete data flow, with model-specific paths highlighted:

```text
═══════════════════════════════════════════════════════════════════════════════
                           STAGE 1: MODEL SELECTION
═══════════════════════════════════════════════════════════════════════════════

    User Request: run_base_model_predictions(base_model='spliceai'|'openspliceai')
                                    │
                                    ▼
                    ┌───────────────────────────────┐
                    │   create_model_config()       │
                    │   (Factory Function)          │
                    └───────────────┬───────────────┘
                                    │
                    ┌───────────────┴───────────────┐
                    │                               │
                    ▼                               ▼
    ┌───────────────────────────┐   ┌───────────────────────────┐
    │     SpliceAIConfig        │   │   OpenSpliceAIConfig      │
    │  ─────────────────────    │   │  ─────────────────────    │
    │  build: GRCh37            │   │  build: GRCh38            │
    │  source: ensembl          │   │  source: mane             │
    │  format: GTF              │   │  format: GFF3             │
    └───────────────┬───────────┘   └───────────────┬───────────┘
                    │                               │
                    ▼                               ▼
    ┌───────────────────────────┐   ┌───────────────────────────┐
    │  Registry(build='GRCh37') │   │ Registry(build='GRCh38_   │
    │                           │   │          MANE')           │
    └───────────────┬───────────┘   └───────────────┬───────────┘
                    │                               │
                    ▼                               ▼
         data/ensembl/GRCh37/            data/mane/GRCh38/

═══════════════════════════════════════════════════════════════════════════════
                           STAGE 2: INPUT FILES
═══════════════════════════════════════════════════════════════════════════════

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                         USER-PROVIDED INPUTS                            │
    │                                                                         │
    │   SpliceAI (GRCh37)                    OpenSpliceAI (GRCh38)            │
    │   ─────────────────                    ────────────────────             │
    │                                                                         │
    │   ┌─────────────────────────┐          ┌─────────────────────────┐     │
    │   │ Homo_sapiens.GRCh37.    │          │ GCF_000001405.40_       │     │
    │   │ dna.primary_assembly.fa │          │ GRCh38.p14_genomic.fna  │     │
    │   │ (Reference Genome)      │          │ (Reference Genome)      │     │
    │   └────────────┬────────────┘          └────────────┬────────────┘     │
    │                │                                    │                   │
    │   ┌─────────────────────────┐          ┌─────────────────────────┐     │
    │   │ Homo_sapiens.GRCh37.    │          │ MANE.GRCh38.v1.3.       │     │
    │   │ 87.gtf                  │          │ refseq_genomic.gff      │     │
    │   │ (Ensembl GTF)           │          │ (MANE GFF3)             │     │
    │   └────────────┬────────────┘          └────────────┬────────────┘     │
    │                │                                    │                   │
    │   ┌─────────────────────────┐          ┌─────────────────────────┐     │
    │   │ spliceai1-5.h5          │          │ openspliceai1-5.pt      │     │
    │   │ (Keras HDF5 models)     │          │ (PyTorch models)        │     │
    │   └────────────┬────────────┘          └────────────┬────────────┘     │
    │                │                                    │                   │
    └────────────────┼────────────────────────────────────┼───────────────────┘
                     │                                    │
                     └──────────────┬─────────────────────┘
                                    │
                                    ▼
═══════════════════════════════════════════════════════════════════════════════
                    STAGE 3: DATA PREPARATION (DERIVED FILES)
═══════════════════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   INPUT: GTF/GFF3 File                                                      │
│          │                                                                  │
│          ▼                                                                  │
│   ┌──────────────────────────────────┐                                      │
│   │  prepare_gene_annotations()      │                                      │
│   │  ────────────────────────────    │                                      │
│   │  • Parses GTF or GFF3 format     │                                      │
│   │  • Extracts transcript metadata  │                                      │
│   │  • Creates indexed database      │                                      │
│   └──────────────┬───────────────────┘                                      │
│                  │                                                          │
│                  ▼                                                          │
│   ┌──────────────────────────────────┐                                      │
│   │  DERIVED: annotations.db         │ ◄── SQLite indexed database         │
│   │  DERIVED: annotations_all_       │ ◄── Flat TSV for processing         │
│   │           transcripts.tsv        │                                      │
│   └──────────────┬───────────────────┘                                      │
│                  │                                                          │
│                  ▼                                                          │
│   ┌──────────────────────────────────┐                                      │
│   │  prepare_splice_site_annotations │                                      │
│   │  ────────────────────────────    │                                      │
│   │  • Extracts donor/acceptor sites │                                      │
│   │  • Validates consensus (GT/AG)   │                                      │
│   │  • Links to gene/transcript IDs  │                                      │
│   └──────────────┬───────────────────┘                                      │
│                  │                                                          │
│                  ▼                                                          │
│   ┌──────────────────────────────────┐                                      │
│   │  DERIVED: splice_sites_          │ ◄── Ground truth for evaluation     │
│   │           enhanced.tsv           │                                      │
│   └──────────────────────────────────┘                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   INPUT: Reference FASTA + Annotations                                      │
│          │                                                                  │
│          ▼                                                                  │
│   ┌──────────────────────────────────┐                                      │
│   │  prepare_genomic_sequences()     │                                      │
│   │  ────────────────────────────    │                                      │
│   │  • Extracts gene sequences       │                                      │
│   │  • Per-chromosome Parquet files  │                                      │
│   │  • Enables lazy loading          │                                      │
│   └──────────────┬───────────────────┘                                      │
│                  │                                                          │
│                  ▼                                                          │
│   ┌──────────────────────────────────┐                                      │
│   │  DERIVED: gene_sequences_        │ ◄── Input to prediction loop        │
│   │           chr{1-22,X,Y}.parquet  │                                      │
│   └──────────────────────────────────┘                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                                                                             │
│   INPUT: Annotations                                                        │
│          │                                                                  │
│          ▼                                                                  │
│   ┌──────────────────────────────────┐                                      │
│   │  handle_overlapping_genes()      │                                      │
│   │  ────────────────────────────    │                                      │
│   │  • Finds genes sharing regions   │                                      │
│   │  • Flags ambiguous splice sites  │                                      │
│   └──────────────┬───────────────────┘                                      │
│                  │                                                          │
│                  ▼                                                          │
│   ┌──────────────────────────────────┐                                      │
│   │  DERIVED: overlapping_gene_      │ ◄── Optional: for filtering         │
│   │           counts.tsv             │                                      │
│   └──────────────────────────────────┘                                      │
│                                                                             │
│   ┌──────────────────────────────────┐                                      │
│   │  GenomicDataDeriver.             │                                      │
│   │  derive_gene_features()          │                                      │
│   │  ────────────────────────────    │                                      │
│   │  • Extracts biotype, length      │                                      │
│   │  • Counts exons, transcripts     │                                      │
│   └──────────────┬───────────────────┘                                      │
│                  │                                                          │
│                  ▼                                                          │
│   ┌──────────────────────────────────┐                                      │
│   │  DERIVED: gene_features.tsv      │ ◄── For stratified analysis         │
│   └──────────────────────────────────┘                                      │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
                    STAGE 4: PREDICTION WORKFLOW
═══════════════════════════════════════════════════════════════════════════════

    DERIVED FILES                          INPUT: Base Models
    ─────────────                          ──────────────────
    gene_sequences_chr{N}.parquet ─────┐   spliceai1-5.h5 (or .pt)
    splice_sites_enhanced.tsv ─────────┼───────────┐
                                       │           │
                                       ▼           ▼
                    ┌──────────────────────────────────────────┐
                    │   run_enhanced_splice_prediction_workflow │
                    │   ───────────────────────────────────────│
                    │                                          │
                    │   FOR chromosome IN chromosomes:         │
                    │   │   load_chromosome_sequences()        │
                    │   │                                      │
                    │   │   FOR chunk IN chunks (500 genes):   │
                    │   │   │   check_checkpoint()             │
                    │   │   │                                  │
                    │   │   │   FOR mini_batch (50 genes):     │
                    │   │   │   │                              │
                    │   │   │   │   ┌────────────────────────┐ │
                    │   │   │   │   │predict_splice_sites_   │ │
                    │   │   │   │   │for_genes()             │ │
                    │   │   │   │   │• One-hot encode seqs   │ │
                    │   │   │   │   │• Run base model        │ │
                    │   │   │   │   │• Get (D, A, N) scores  │ │
                    │   │   │   │   └──────────┬─────────────┘ │
                    │   │   │   │              │               │
                    │   │   │   │              ▼               │
                    │   │   │   │   ┌────────────────────────┐ │
                    │   │   │   │   │enhanced_process_       │ │
                    │   │   │   │   │predictions_with_all_   │ │
                    │   │   │   │   │scores()                │ │
                    │   │   │   │   │• Compare to ground     │ │
                    │   │   │   │   │  truth splice sites    │ │
                    │   │   │   │   │• Classify TP/FP/FN/TN  │ │
                    │   │   │   │   │• Compute ~58 features  │ │
                    │   │   │   │   └──────────┬─────────────┘ │
                    │   │   │   │              │               │
                    │   │   │   │              ▼               │
                    │   │   │   │   ┌────────────────────────┐ │
                    │   │   │   │   │extract_analysis_       │ │
                    │   │   │   │   │sequences()             │ │
                    │   │   │   │   │• Extract ±250bp window │ │
                    │   │   │   │   │• Store for downstream  │ │
                    │   │   │   │   └──────────┬─────────────┘ │
                    │   │   │   │              │               │
                    │   │   │   │   FREE MEMORY (gc.collect)   │
                    │   │   │   │                              │
                    │   │   │   SAVE CHUNK ARTIFACTS           │
                    │   │                                      │
                    │   FREE CHROMOSOME MEMORY                 │
                    │                                          │
                    └──────────────────────────────────────────┘
                                       │
                                       ▼
═══════════════════════════════════════════════════════════════════════════════
                    STAGE 5: OUTPUT FILES
═══════════════════════════════════════════════════════════════════════════════

    ┌─────────────────────────────────────────────────────────────────────────┐
    │                         WORKFLOW OUTPUTS                                │
    │                                                                         │
    │   Per-Chunk Files (Intermediate)         Aggregated Files (Final)       │
    │   ──────────────────────────────         ────────────────────────       │
    │                                                                         │
    │   splice_positions_enhanced_             splice_positions_enhanced_     │
    │   {chr}_chunk_{start}_{end}.tsv    ──►   aggregated.tsv                 │
    │   │                                      │                              │
    │   │  Columns (~58):                      │  • All positions combined    │
    │   │  • gene_id, position, strand         │  • Ready for meta-model      │
    │   │  • donor_score, acceptor_score       │    training                  │
    │   │  • context_donor_±2                  │                              │
    │   │  • derived features (ratios,         │                              │
    │   │    log-odds, entropy, etc.)          │                              │
    │   │  • label (TP/TN)                     │                              │
    │                                                                         │
    │   error_analysis_{chr}_chunk_            error_analysis_aggregated.tsv  │
    │   {start}_{end}.tsv                ──►   │                              │
    │   │                                      │  • Per-gene error metrics    │
    │   │  Columns:                            │  • Quality assessment        │
    │   │  • gene_id, n_TP, n_FP, n_FN         │                              │
    │   │  • precision, recall, F1             │                              │
    │                                                                         │
    │   analysis_sequences_{chr}_chunk_        analysis_sequences_            │
    │   {start}_{end}.tsv                ──►   aggregated.tsv                 │
    │   │                                      │                              │
    │   │  Columns:                            │  • Sequence contexts         │
    │   │  • gene_id, position, sequence       │  • For motif analysis        │
    │   │  • splice_type, label                │                              │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
                    STAGE 6: DOWNSTREAM USAGE
═══════════════════════════════════════════════════════════════════════════════

    OUTPUT FILES                              DOWNSTREAM APPLICATIONS
    ────────────                              ──────────────────────

    splice_positions_enhanced_     ──────►    Meta-Model Training
    aggregated.tsv                            │
    │                                         │  • Train classifier on
    │  ~58 features per position              │    position-level features
    │  Labels: TP (1), TN (0)                 │  • Predict error likelihood
    │                                         │  • Improve base model accuracy
    │
    error_analysis_aggregated.tsv  ──────►    Quality Assessment
    │                                         │
    │  Per-gene metrics                       │  • Identify hard genes
    │  Precision, Recall, F1                  │  • Stratify by biotype
    │                                         │  • Compare model versions
    │
    analysis_sequences_            ──────►    Sequence Analysis
    aggregated.tsv                            │
    │                                         │  • Motif discovery
    │  ±250bp around splice sites             │  • Variant impact prediction
    │                                         │  • Feature engineering
```

### Compact Summary: Input → Processing → Derived → Usage

```text
┌─────────────────────────────────────────────────────────────────────────────┐
│ INPUT                  PROCESSING                DERIVED           USAGE    │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ GTF/GFF3 ──────────► prepare_gene_annotations() ──► annotations.db          │
│                              │                       annotations_all_*.tsv  │
│                              ▼                              │               │
│                      prepare_splice_site_       ◄───────────┘               │
│                      annotations()                                          │
│                              │                                              │
│                              ▼                                              │
│                      splice_sites_enhanced.tsv ─────────► Ground truth      │
│                                                            for evaluation   │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ FASTA ─────────────► prepare_genomic_sequences() ──► gene_sequences_        │
│ + annotations                                         chr{N}.parquet        │
│                                                            │                │
│                                                            ▼                │
│                                                       Prediction input      │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ Base Model ────────► predict_splice_sites_for_genes()                       │
│ (SpliceAI/                    │                                             │
│  OpenSpliceAI)                ▼                                             │
│                      Per-nucleotide scores (D, A, N)                        │
│                              │                                              │
│                              ▼                                              │
│ splice_sites_*.tsv ► enhanced_process_predictions_with_all_scores()         │
│ (ground truth)               │                                              │
│                              ▼                                              │
│                      splice_positions_enhanced_*.tsv ──► Meta-model         │
│                      error_analysis_*.tsv ─────────────► training           │
│                                                                             │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│ gene_sequences_*.   ► extract_analysis_sequences()                          │
│ parquet                      │                                              │
│                              ▼                                              │
│                      analysis_sequences_*.tsv ─────────► Sequence           │
│                                                          analysis           │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## File Size Estimates

| File Type | Per-Chromosome | Full Genome | Notes |
|-----------|----------------|-------------|-------|
| Reference FASTA | N/A | ~3.1 GB | Uncompressed |
| GTF Annotations | N/A | ~1.5 GB | Uncompressed |
| SpliceAI Models | N/A | ~250 MB | 5 models total |
| Gene Sequences | 100-500 MB | ~5 GB | Parquet compressed |
| Splice Sites | N/A | ~50-100 MB | TSV |
| Splice Positions | 20-50 MB | ~500 MB - 2 GB | Depends on TN sampling |
| Analysis Sequences | 50-200 MB | ~1-5 GB | Includes sequence strings |

**Total Disk Space Required**: ~15-20 GB for full genome analysis

---

## Key Takeaways for Porting

### Essential Files (Must Have)

| Priority | File | Reason |
|----------|------|--------|
| **P0** | Reference FASTA | Required for sequence extraction |
| **P0** | GTF Annotations | Required for splice site positions |
| **P0** | SpliceAI Models | Required for prediction |

### Derived Files (Can Regenerate)

| File | Regeneration Time | Recommendation |
|------|-------------------|----------------|
| `annotations.db` | ~5-10 min | Cache if possible |
| `splice_sites_enhanced.tsv` | ~10-20 min | Cache if possible |
| `gene_sequences_*.parquet` | ~30-60 min | Cache strongly recommended |
| `overlapping_gene_counts.tsv` | ~5 min | Optional for basic usage |

### Build-Specific vs. Shared

| File Type | Build-Specific? | Notes |
|-----------|-----------------|-------|
| Reference FASTA | Yes | GRCh37 vs GRCh38 coordinates differ |
| GTF Annotations | Yes | Release-specific gene models |
| Splice Sites | Yes | Coordinates are build-specific |
| Gene Sequences | Yes | Extracted from build-specific FASTA |
| Base Model Weights | **Model-specific** | SpliceAI trained on GRCh37, OpenSpliceAI on GRCh38 |

---

## Unified Base Model Interface

### Architecture Overview

The Meta-SpliceAI system provides a **model-agnostic interface** that works with any base model producing per-nucleotide splice scores:

```text
┌─────────────────────────────────────────────────────────────────────┐
│                    UNIFIED INTERFACE                                │
│                                                                     │
│   run_base_model_predictions(base_model='spliceai'|'openspliceai') │
│                              │                                      │
│                              ▼                                      │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │              create_model_config(base_model)                │  │
│   │                          │                                  │  │
│   │          ┌───────────────┴───────────────┐                  │  │
│   │          ▼                               ▼                  │  │
│   │   SpliceAIConfig              OpenSpliceAIConfig            │  │
│   │   - build: GRCh37             - build: GRCh38               │  │
│   │   - source: ensembl           - source: mane                │  │
│   │   - format: GTF               - format: GFF3                │  │
│   │   - models: Keras .h5         - models: PyTorch .pt         │  │
│   └─────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ▼                                      │
│   ┌─────────────────────────────────────────────────────────────┐  │
│   │        run_enhanced_splice_prediction_workflow()            │  │
│   │        (Same workflow, different data paths)                │  │
│   └─────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────┘
```

### Configuration Classes

The system uses a class hierarchy for model-specific configuration:

```python
# Abstract base class
class BaseModelConfig(ABC):
    genome_fasta: str      # Path to reference genome
    gtf_file: str          # Path to annotations
    eval_dir: str          # Output directory
    
    @property
    @abstractmethod
    def base_model(self) -> str:
        """Return model identifier ('spliceai', 'openspliceai', etc.)"""
        pass

# SpliceAI-specific (GRCh37/Ensembl)
class SpliceAIConfig(BaseModelConfig):
    def __post_init__(self):
        # Auto-resolves to data/ensembl/GRCh37/
        registry = Registry(build='GRCh37')
        self.genome_fasta = registry.get_fasta_path()
        self.gtf_file = registry.get_gtf_path()

# OpenSpliceAI-specific (GRCh38/MANE)
class OpenSpliceAIConfig(BaseModelConfig):
    def __post_init__(self):
        # Auto-resolves to data/mane/GRCh38/
        registry = Registry(build='GRCh38_MANE')
        self.genome_fasta = registry.get_fasta_path()
        self.gtf_file = registry.get_gtf_path()
```

### Usage Examples

```python
# Using SpliceAI (GRCh37)
from meta_spliceai import run_base_model_predictions

results = run_base_model_predictions(
    base_model='spliceai',
    target_genes=['BRCA1', 'TP53']
)

# Using OpenSpliceAI (GRCh38)
results = run_base_model_predictions(
    base_model='openspliceai',
    target_genes=['BRCA1', 'TP53']
)

# CLI interface
# run_base_model --base-model spliceai --genes BRCA1,TP53
# run_base_model --base-model openspliceai --genes BRCA1,TP53
```

### Adding Custom Base Models

To add a new base model:

1. **Create config class** inheriting from `BaseModelConfig`
2. **Implement `base_model` property** returning model identifier
3. **Set up data directory** following `data/<source>/<build>/` pattern
4. **Register model** in `create_model_config()` factory function

```python
@dataclass
class MyCustomModelConfig(BaseModelConfig):
    @property
    def base_model(self) -> str:
        return 'my_custom_model'
    
    def __post_init__(self):
        # Auto-resolve paths for your model's training data
        registry = Registry(build='GRCh38', source='gencode')
        self.genome_fasta = registry.get_fasta_path()
        self.gtf_file = registry.get_gtf_path()
```

---

## Key Takeaways for Porting

### Multi-Model Support Requirements

| Requirement | Implementation |
|-------------|----------------|
| Model selection | `base_model` parameter in API |
| Auto path resolution | `Registry` class with build/source |
| Config inheritance | `BaseModelConfig` → `SpliceAIConfig`/`OpenSpliceAIConfig` |
| Directory separation | `data/<source>/<build>/` structure |

### Data Compatibility Matrix

| Base Model | Genome Build | Annotation Format | Data Directory |
|------------|--------------|-------------------|----------------|
| SpliceAI | GRCh37 | Ensembl GTF | `data/ensembl/GRCh37/` |
| OpenSpliceAI | GRCh38 | MANE GFF3 | `data/mane/GRCh38/` |
| Custom | Any | Any | `data/<source>/<build>/` |

---

**Next**: Stage 3, Step 2 - Trace data flow between functions
